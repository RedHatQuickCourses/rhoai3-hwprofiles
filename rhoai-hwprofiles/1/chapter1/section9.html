<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Optimizing AI Clusters with Kueue &amp; Priority :: Hardware Governance at Scale with RHOAI Hardware Profiles.</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Hardware Governance at Scale with RHOAI Hardware Profiles.</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/REPLACEREPONAME/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhoai-hwprofiles" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Hardware Governance at Scale with RHOAI Hardware Profiles.</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="hwprofiles.html">Hardware Profiles Guide</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="placement.html">Taints &amp; Tolerations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tiering.html">Hardware Profile Tiering Strategy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tiering.html">Hardware Profile Tiering Strategy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="summary.html">Course Summary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Hardware Governance at Scale with RHOAI Hardware Profiles.</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Hardware Governance at Scale with RHOAI Hardware Profiles.</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Hardware Governance at Scale with RHOAI Hardware Profiles.</a></li>
    <li><a href="section9.html">Lab: Optimizing AI Clusters with Kueue &amp; Priority</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Optimizing AI Clusters with Kueue &amp; Priority</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_he_business_value_of_kueue">he Business Value of Kueue</a></li>
<li><a href="#_2_lab_environment_setup">2. Lab Environment Setup</a>
<ul class="sectlevel2">
<li><a href="#_create_the_project_namespace">Create the Project Namespace</a></li>
</ul>
</li>
<li><a href="#_3_exercise_1_building_the_basic_cpu_queue">3. Exercise 1: Building the Basic CPU Queue</a>
<ul class="sectlevel2">
<li><a href="#_create_resource_flavor_and_clusterqueue">Create Resource Flavor and ClusterQueue</a></li>
</ul>
</li>
<li><a href="#_4_exercise_2_testing_priority_and_preemption">4. Exercise 2: Testing Priority and Preemption</a>
<ul class="sectlevel2">
<li><a href="#_step_4_1_define_priority_tiers">Step 4.1: Define Priority Tiers</a></li>
<li><a href="#_step_4_2_enable_preemption_on_the_queue">Step 4.2: Enable Preemption on the Queue</a></li>
<li><a href="#_step_4_3_start_a_standard_job_the_resource_occupier">Step 4.3: Start a "Standard" Job (The Resource Occupier)</a></li>
<li><a href="#_step_4_4_start_a_vip_job_the_high_roi_task">Step 4.4: Start a "VIP" Job (The High ROI Task)</a></li>
</ul>
</li>
<li><a href="#_5_observing_the_result">5. Observing the Result</a></li>
<li><a href="#_6_exercise_3_fair_sharing_and_cohorts">6. Exercise 3: Fair Sharing and Cohorts</a>
<ul class="sectlevel2">
<li><a href="#_step_6_1_setup_the_second_project">Step 6.1: Setup the Second Project</a></li>
<li><a href="#_step_6_2_define_shared_cohort_and_weighted_queues">Step 6.2: Define Shared Cohort and Weighted Queues</a></li>
<li><a href="#_step_6_3_observe_borrowing_in_action">Step 6.3: Observe "Borrowing" in Action</a></li>
</ul>
</li>
<li><a href="#_7_lab_conclusion_maximizing_roi">7. Lab Conclusion: Maximizing ROI</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_he_business_value_of_kueue"><a class="anchor" href="#_he_business_value_of_kueue"></a>he Business Value of Kueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In high-performance AI environments, hardware like GPUs and high-core-count CPUs are your most expensive assets. Without proper orchestration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Waste occurs:</strong> Standard low-priority pods (like web servers) might "squat" on expensive AI nodes.</p>
</li>
<li>
<p><strong>Low ROI:</strong> Expensive hardware sits idle because one user "hoarded" resources they aren&#8217;t currently using.</p>
</li>
<li>
<p><strong>Bottlenecks:</strong> Critical production training jobs get stuck behind experimental notebooks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Kueue</strong> maximizes your Return on Investment (ROI) by ensuring that resources are always doing the most valuable work possible through <strong>Quota Management</strong> and <strong>Priority Preemption</strong>.</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_2_lab_environment_setup"><a class="anchor" href="#_2_lab_environment_setup"></a>2. Lab Environment Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This lab assumes the <strong>Red Hat Build of Kueue</strong> operator is installed and OpenShift AI 3.0 is running in <code>Unmanaged</code> mode for the Kueue component.</p>
</div>
<div class="sect2">
<h3 id="_create_the_project_namespace"><a class="anchor" href="#_create_the_project_namespace"></a>Create the Project Namespace</h3>
<div class="paragraph">
<p>We will create a specific namespace for our hardware profile testing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Create the new project
oc new-project deploy-hwprofiles

# Label the namespace so Kueue's admission controller watches it
oc label namespace deploy-hwprofiles kueue.x-k8s.io/ignore-separator=true --overwrite</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_exercise_1_building_the_basic_cpu_queue"><a class="anchor" href="#_3_exercise_1_building_the_basic_cpu_queue"></a>3. Exercise 1: Building the Basic CPU Queue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this exercise, we define a "Hard Limit" for our project. This prevents "Resource Sprawl" where one project consumes the entire cluster&#8217;s CPU.</p>
</div>
<div class="sect2">
<h3 id="_create_resource_flavor_and_clusterqueue"><a class="anchor" href="#_create_resource_flavor_and_clusterqueue"></a>Create Resource Flavor and ClusterQueue</h3>
<div class="paragraph">
<p>Run the following to define a global pool of <strong>4 CPUs</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -f -
apiVersion: kueue.x-k8s.io/v1beta1
kind: ResourceFlavor
metadata:
  name: default-flavor
---
apiVersion: kueue.x-k8s.io/v1beta1
kind: ClusterQueue
metadata:
  name: cluster-queue
spec:
  namespaceSelector: {}
  resourceGroups:
  - coveredResources: ["cpu", "memory"]
    flavors:
    - name: default-flavor
      resources:
      - name: "cpu"
        nominalQuota: 4
      - name: "memory"
        nominalQuota: 16Gi
---
apiVersion: kueue.x-k8s.io/v1beta1
kind: LocalQueue
metadata:
  name: user-queue
  namespace: deploy-hwprofiles
spec:
  clusterQueue: cluster-queue
EOF</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_exercise_2_testing_priority_and_preemption"><a class="anchor" href="#_4_exercise_2_testing_priority_and_preemption"></a>4. Exercise 2: Testing Priority and Preemption</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we will simulate a real-world conflict: A "Standard" user takes up the resources, and a "VIP" user needs to jump the line.</p>
</div>
<div class="sect2">
<h3 id="_step_4_1_define_priority_tiers"><a class="anchor" href="#_step_4_1_define_priority_tiers"></a>Step 4.1: Define Priority Tiers</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -f -
apiVersion: kueue.x-k8s.io/v1beta1
kind: WorkloadPriorityClass
metadata:
  name: vip-priority
value: 1000
description: "High priority for production AI jobs"
---
apiVersion: kueue.x-k8s.io/v1beta1
kind: WorkloadPriorityClass
metadata:
  name: standard-priority
value: 100
description: "Standard priority for development jobs"
EOF</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_2_enable_preemption_on_the_queue"><a class="anchor" href="#_step_4_2_enable_preemption_on_the_queue"></a>Step 4.2: Enable Preemption on the Queue</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch clusterqueue cluster-queue --type merge -p '{"spec": {"preemption": {"withinClusterQueue": "LowerPriority"}}}'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_3_start_a_standard_job_the_resource_occupier"><a class="anchor" href="#_step_4_3_start_a_standard_job_the_resource_occupier"></a>Step 4.3: Start a "Standard" Job (The Resource Occupier)</h3>
<div class="paragraph">
<p>This job asks for <strong>3 CPUs</strong>, leaving only 1 available in our 4-CPU quota.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -f -
apiVersion: batch/v1
kind: Job
metadata:
  name: standard-dev-job
  namespace: deploy-hwprofiles
  labels:
    kueue.x-k8s.io/queue-name: user-queue
    kueue.x-k8s.io/priority-class: standard-priority
spec:
  template:
    spec:
      containers:
      - name: dummy
        image: busybox
        command: ["sleep", "600"]
        resources:
          requests:
            cpu: "3"
      restartPolicy: Never
EOF</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_4_start_a_vip_job_the_high_roi_task"><a class="anchor" href="#_step_4_4_start_a_vip_job_the_high_roi_task"></a>Step 4.4: Start a "VIP" Job (The High ROI Task)</h3>
<div class="paragraph">
<p>This job requires <strong>2 CPUs</strong>. Since 3 are taken, it normally would wait. Because of <strong>Preemption</strong>, it will evict the standard job.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -f -
apiVersion: batch/v1
kind: Job
metadata:
  name: production-vip-job
  namespace: deploy-hwprofiles
  labels:
    kueue.x-k8s.io/queue-name: user-queue
    kueue.x-k8s.io/priority-class: vip-priority
spec:
  template:
    spec:
      containers:
      - name: dummy
        image: busybox
        command: ["sleep", "600"]
        resources:
          requests:
            cpu: "2"
      restartPolicy: Never
EOF</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_observing_the_result"><a class="anchor" href="#_5_observing_the_result"></a>5. Observing the Result</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Navigate to the <strong>OpenShift AI Dashboard</strong> &#8594; <strong>Distributed Workloads</strong>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Observation</strong></th>
<th class="tableblock halign-left valign-top"><strong>Explanation</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Job Eviction</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use <code>oc get pods</code>. You will see <code>standard-dev-job</code> pods terminating to make room.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Dashboard Status</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The VIP job will show as "Running" and the Standard job will show as "Pending" or "Evicted".</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ROI Success</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You have successfully ensured that the most critical business task has access to compute without needing to manually scale the cluster.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_6_exercise_3_fair_sharing_and_cohorts"><a class="anchor" href="#_6_exercise_3_fair_sharing_and_cohorts"></a>6. Exercise 3: Fair Sharing and Cohorts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this exercise, we will create two separate projects (Team A and Team B). They will share a common pool of resources (a <strong>Cohort</strong>), but we will weight them so Team A is considered "more important."</p>
</div>
<div class="sect2">
<h3 id="_step_6_1_setup_the_second_project"><a class="anchor" href="#_step_6_1_setup_the_second_project"></a>Step 6.1: Setup the Second Project</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Create Team B's project
oc new-project team-b-research
oc label namespace team-b-research kueue.x-k8s.io/ignore-separator=true --overwrite</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_6_2_define_shared_cohort_and_weighted_queues"><a class="anchor" href="#_step_6_2_define_shared_cohort_and_weighted_queues"></a>Step 6.2: Define Shared Cohort and Weighted Queues</h3>
<div class="paragraph">
<p>We will update the <code>ClusterQueues</code> to join the same <code>cohort</code>. We will also add <code>fairSharing</code> weights.
 * <strong>Team A (deploy-hwprofiles):</strong> Weight 3 (Gets 75% of shared space)
 * <strong>Team B (team-b-research):</strong> Weight 1 (Gets 25% of shared space)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -f -
apiVersion: kueue.x-k8s.io/v1beta1
kind: ClusterQueue
metadata:
  name: team-a-cq
spec:
  namespaceSelector: {}
  cohort: "ai-compute-pool" # This link enables sharing
  fairSharing:
    weight: "3"
  resourceGroups:
  - coveredResources: ["cpu", "memory"]
    flavors:
    - name: default-flavor
      resources:
      - name: "cpu"
        nominalQuota: 2 # Guaranteed amount
---
apiVersion: kueue.x-k8s.io/v1beta1
kind: ClusterQueue
metadata:
  name: team-b-cq
spec:
  namespaceSelector: {}
  cohort: "ai-compute-pool"
  fairSharing:
    weight: "1"
  resourceGroups:
  - coveredResources: ["cpu", "memory"]
    flavors:
    - name: default-flavor
      resources:
      - name: "cpu"
        nominalQuota: 2 # Guaranteed amount
---
apiVersion: kueue.x-k8s.io/v1beta1
kind: LocalQueue
metadata:
  name: team-b-queue
  namespace: team-b-research
spec:
  clusterQueue: team-b-cq
EOF</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_6_3_observe_borrowing_in_action"><a class="anchor" href="#_step_6_3_observe_borrowing_in_action"></a>Step 6.3: Observe "Borrowing" in Action</h3>
<div class="paragraph">
<p>If <code>team-b-research</code> submits a job requiring <strong>4 CPUs</strong>, it will use its own 2 CPUs and "borrow" the 2 unused CPUs from Team A.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Run this to see the current 'Share' status
oc get clusterqueue -o custom-columns=NAME:.metadata.name,COHORT:.spec.cohort,WEIGHT:.spec.fairSharing.weight</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_7_lab_conclusion_maximizing_roi"><a class="anchor" href="#_7_lab_conclusion_maximizing_roi"></a>7. Lab Conclusion: Maximizing ROI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By completing these three exercises, you have moved from a static cluster to an <strong>Elastic AI Infrastructure</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Stop Waste:</strong> Through Cohorts, resources never sit idle if someone has work to do.</p>
</li>
<li>
<p><strong>Ensure Predictability:</strong> Through Fair Sharing, you have a mathematical guarantee that "Borrowers" won&#8217;t block "Owners."</p>
</li>
<li>
<p><strong>Protect Production:</strong> Through Priority, you ensure that even in a full cluster, the most valuable business logic (VIP) always runs first.</p>
</li>
</ol>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
